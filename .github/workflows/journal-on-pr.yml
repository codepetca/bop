name: Auto-Journal PR Events

on:
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened, closed]

jobs:
  journal:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      issues: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update journal
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine event type and status
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ITEM_TYPE="PR"
            ITEM_NUMBER="${{ github.event.pull_request.number }}"
            ITEM_TITLE="${{ github.event.pull_request.title }}"
            ITEM_USER="${{ github.event.pull_request.user.login }}"
            ITEM_ACTION="${{ github.event.action }}"

            if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              STATUS="merged"
            elif [ "$ITEM_ACTION" = "closed" ]; then
              STATUS="closed without merge"
            else
              STATUS="$ITEM_ACTION"
            fi

            # Get files changed (if PR exists)
            if [ "$ITEM_ACTION" != "opened" ]; then
              FILES=$(gh pr view $ITEM_NUMBER --json files --jq '.files[].path' 2>/dev/null | head -5 | paste -sd "," - || echo "")
            else
              FILES=""
            fi

          else
            ITEM_TYPE="Issue"
            ITEM_NUMBER="${{ github.event.issue.number }}"
            ITEM_TITLE="${{ github.event.issue.title }}"
            ITEM_USER="${{ github.event.issue.user.login }}"
            ITEM_ACTION="${{ github.event.action }}"
            STATUS="$ITEM_ACTION"
            FILES=""
          fi

          # Append to journal
          cat >> .ai/JOURNAL.md << EOF

          ---
          ## $(date '+%Y-%m-%d %H:%M') [GITHUB-EVENT]
          **Event:** $ITEM_TYPE #$ITEM_NUMBER $STATUS
          **Title:** $ITEM_TITLE
          **By:** $ITEM_USER
          **Files:** $FILES
          **Status:** $STATUS
          **Context:** Automatically logged by GitHub Actions
          ---
          EOF

      - name: Commit journal
        run: |
          git config user.name "WristBop Journal Bot"
          git config user.email "journal-bot@wristbop.dev"

          if [[ -n $(git status -s .ai/JOURNAL.md) ]]; then
            git add .ai/JOURNAL.md
            git commit -m "docs: auto-journal ${{ github.event_name }} #${{ github.event.pull_request.number || github.event.issue.number }}"
            git push
          fi
